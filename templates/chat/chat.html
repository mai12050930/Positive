{% load static %}
<!DOCTYPE html>
<html>

<head>
    <title>Chat</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/chat.css' %}">
    <script type="text/javascript" src="{% static 'js/style.js' %}"></script>
</head>

<body>
    <p>
        <image src="{% static 'images/game_logo.jpg' %}" alt="ゲームロゴ" />
    </p>

    <div id="div_container">

        <div id="div_main">
            <div id="div_join_screen">
                <form action="" onsubmit="onsubmitButton_JoinChat(); return false;">
                    Use rname<br>
                    <input type="text" id="input_username" placeholder="Enter User name" autofocus><br><br>
                    <input type="submit" value="Join Chat">
                </form>
            </div>

            <div id="div_chat_screen">
                <button onclick="onclickButton_LeaveChat()">Leave Chat.</button><br>
                User name :
                <input type="text" id="text_username" readonly="readonly"><br>
                <!-- 送信フォーム -->
                <form name="chat_send" action="" onsubmit="onsubmitButton_Send(); return false;">
                    Message :
                    <input type="text" name="text" id="input_message" autocomplete="off" autofocus />
                    <input type="submit" value="Send" />
                </form>

                <ul id="list_message"></ul>
            </div>
        </div>
    </div>

    <script>
        const g_elementDivJoinScreen = document.getElementById("div_join_screen");
        const g_elementDivChatScreen = document.getElementById("div_chat_screen");
        const g_elementInputUserName = document.getElementById("input_username");

        const g_elementTextUserName = document.getElementById("text_username");

        const g_elementInputMessage = document.getElementById("input_message");
        const g_elementListMessage = document.getElementById("list_message");


        //WebSocketオブジェクト
        let ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
        const g_socket = new WebSocket(ws_scheme + "://" + window.location.host + "/ws/chat/");

        //Joinボタンを押した時の処理
        function onsubmitButton_JoinChat() {
            //ユーザー名
            let strInputUserName = g_elementInputUserName.value;
            if (!strInputUserName) {
                return;
            }
            g_elementTextUserName.value = strInputUserName;

            //サーバーにjoin送信
            g_socket.send(JSON.stringify({
                "data_type": "join",
                "username": strInputUserName
            }));

            //画面の切り替え
            g_elementDivJoinScreen.style.display = "none"; //参加画面の非表示
            g_elementDivChatScreen.style.display = "block"; //チャット画面の表示
        }

        //Leave Chatボタンを押すと呼ばれる関数
        function onclickButton_LeaveChat() {
            //メッセージリストのクリア
            while (g_elementListMessage.firstChild) {
                g_elementListMessage.removeChild(g_elementListMessage.firstChild);
            }

            //ユーザー名
            g_elementTextUserName.value = "";

            //サーバーに"leave"を送信
            g_socket.send(JSON.stringify({
                "data_type": "leave"
            }));

            //画面の切り替え
            g_elementDivChatScreen.style.display = "none"; //チャット画面の非表示
            g_elementDivJoinScreen.style.display = "flex"; //参加画面の表示
        }

        //Sendボタンを押したときの処理
        function onsubmitButton_Send() {
            //送信用テキストHTML要素からメッセージ文字列取得
            let strMessage = g_elementInputMessage.value;
            if (!strMessage) {
                return;
            }
            //WebSocketを通したメッセージ送信
            g_socket.send(JSON.stringify({
                "message": strMessage
            }));

            //送信用テキストHTML要素の中身クリア
            g_elementInputMessage.value = "";
        }

        //WebSocketからメッセージ受信時の処理
        g_socket.onmessage = (event) => {
            //自身がまだ参加していない時は無視
            if (!g_elementTextUserName.value) {
                return;
            }

            //テキストデータをJSONデータにデコード
            let data = JSON.parse(event.data);

            //メッセージの整形
            let strMessage = data["datetime"] + "-[" + data["username"] + "]" + data["message"];

            //拡散されたメッセージをメッセージリストに追加
            let elementLi = document.createElement("li");
            elementLi.textContent = strMessage;
            g_elementListMessage.prepend(elementLi); //リストの一番上に追加
            //g_elementListMessage.append(elementLi); //リストの一番下に追加
        };

        //WebSocketクローズ時の処理
        g_socket.onclose = (event) => {
            //ウェブページを閉じたとき以外のWebSocketクローズは想定外
            console.error("Unexpected : Chat socket closed.");
        };
    </script>

    <!-- <script type="text/javascript" src="{% static 'js/chat.js' %}"></script> -->

</body>

</html>